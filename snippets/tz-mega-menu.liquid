{% comment %}
  Snippet: tz-mega-menu.liquid (Debug Version)
{% endcomment %}

{% assign link_title_clean = link.title | strip | downcase %}
{% assign has_mega_content = false %}
{% assign mega_settings = null %}

<!-- DEBUG: Link is "{{ link_title_clean }}" -->

{% for block in blocks %}
  {% assign block_trigger_clean = block.settings.menu_trigger | strip | downcase %}

  <!-- DEBUG: Comparing with Block Trigger "{{ block_trigger_clean }}" -->

  {% if block_trigger_clean == link_title_clean %}
    {% if block.type == 'mega_menu_settings' %}
      {% assign mega_settings = block %}
    {% else %}
      {% assign has_mega_content = true %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if has_mega_content or mega_settings != null %}
  <div
    class="tz-mega-menu"
    id="mega-menu-{{ index }}"
    data-trigger-debug="{{ link_title_clean }}"
    {% if mega_settings %}
      style="
        --tz-mm-bg: {{ mega_settings.settings.bg_color | default: '#ffffff' }};
        --tz-mm-text: {{ mega_settings.settings.text_color | default: '#000000' }};
        --tz-mm-min-height: {{ mega_settings.settings.min_height }}px;
      "
    {% endif %}
  >
    <div class="tz-mega-menu-container">
      {% for block in blocks %}
        {% assign block_trigger_clean = block.settings.menu_trigger | strip | downcase %}

        {% if block_trigger_clean == link_title_clean and block.type != 'mega_menu_settings' %}
          <div class="tz-mm-block tz-mm-block--{{ block.type | replace: '_', '-' }}">
            {% case block.type %}
              {% when 'menu_block' %}
                {% if block.settings.heading != blank %}
                  <h4 class="tz-mm-heading">{{ block.settings.heading }}</h4>
                {% endif %}
                {% if block.settings.menu != blank %}
                  <ul class="tz-mm-linklist">
                    {% for link in linklists[block.settings.menu].links %}
                      <li>
                        <a href="{{ link.url }}">{{ link.title }}</a>
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}

              {% when 'rich_text_block' %}
                <div class="tz-mm-richtext">
                  {% if block.settings.heading != blank %}
                    <h4 class="tz-mm-heading">{{ block.settings.heading }}</h4>
                  {% endif %}
                  <div class="rte">{{ block.settings.text }}</div>
                </div>

              {% when 'image_block' %}
                <div class="tz-mm-image">
                  {% if block.settings.link != blank %}<a href="{{ block.settings.link }}">{% endif %}
                  {% if block.settings.image != blank %}
                    <img
                      src="{{ block.settings.image | image_url: width: 600 }}"
                      loading="lazy"
                      width="{{ block.settings.image.width }}"
                      height="{{ block.settings.image.height }}"
                    >
                  {% endif %}
                  {% if block.settings.link != blank %}</a>{% endif %}
                </div>

              {% when 'product_block' %}
                {% assign product = all_products[block.settings.product] %}
                <div class="tz-mm-product">
                  {% if product != blank %}
                    <a href="{{ product.url }}" class="tz-mm-product-card">
                      <div class="tz-mm-product-img">
                        <img src="{{ product.featured_image | image_url: width: 400 }}">
                      </div>
                      <div class="tz-mm-product-info">
                        <span>{{ product.title }}</span>
                      </div>
                    </a>
                  {% endif %}
                </div>
            {% endcase %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
{% endif %}

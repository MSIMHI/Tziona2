{% comment %}
  RTL-First Product Page
  Built from scratch to match product_detail_page.html structure
{% endcomment %}

{%- liquid
  assign is_hebrew = false
  assign locale_code = request.locale.iso_code | downcase
  assign shop_locale = shop.locale | downcase
  if locale_code == 'he' or locale_code == 'iw' or shop_locale == 'he' or shop_locale == 'iw' or locale_code contains 'he' or shop_locale contains 'he'
    assign is_hebrew = true
  endif
-%}

{{ 'tz-product.css' | asset_url | stylesheet_tag }}

<product-info
  id="MainProduct-{{ section.id }}"
  class="tz-product-section"
  data-section="{{ section.id }}"
  data-product-id="{{ product.id }}"
  data-update-url="true"
  data-url="{{ product.url }}"
>
  <script type="application/json" data-product-json>
    {
      "variants": [
        {%- for variant in product.variants -%}
        {
          "id": {{ variant.id }},
          "title": {{ variant.title | json }},
          "price": {{ variant.price }},
          "compare_at_price": {{ variant.compare_at_price | default: 0 }},
          "available": {{ variant.available | json }},
          "options": {{ variant.options | json }},
          "featured_media": {% if variant.featured_media %}{"id": {{ variant.featured_media.id }}}{% else %}null{% endif %}
        }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ]
    }
  </script>
  <div class="tz-product-container">
    {%- comment -%} Breadcrumb Navigation {%- endcomment -%}
    {% if section.settings.show_breadcrumb %}
      <nav aria-label="Breadcrumb" class="tz-product-breadcrumb">
        <a href="{{ routes.root_url }}">דף הבית</a>
        <span>/</span>
        <a href="{{ routes.collections_url }}">מותגים</a>
        <span>/</span>
        {% if product.vendor %}
          <a href="{{ product.vendor | url_for_vendor }}">{{ product.vendor }}</a>
          <span>/</span>
        {% endif %}
        <span>{{ product.title }}</span>
      </nav>
    {% endif %}

    {%- comment -%} Main Product Grid {%- endcomment -%}
    <div class="tz-product-grid">
      {%- comment -%} Product Info (Right Side - RTL) {%- endcomment -%}
      <div class="tz-product-info">
        <div class="tz-product-info-inner">
          {%- comment -%} Vendor & Badge Row {%- endcomment -%}
          <div class="tz-product-header-row">
            {% if section.settings.show_vendor and product.vendor %}
              <h2 class="tz-product-vendor">{{ product.vendor | escape }}</h2>
            {% endif %}
            {% if product.metafields.custom.last_call == true or section.settings.show_last_call_badge %}
              <div class="tz-product-badge-last-call">
                LAST <br>
                CALL
                <span class="badge-icon material-icons-outlined">flight</span>
              </div>
            {% endif %}
          </div>

          {%- comment -%} Product Title {%- endcomment -%}
          <h1 class="tz-product-title">{{ product.title | escape }}</h1>

          {%- comment -%} Price {%- endcomment -%}
          <div class="tz-product-price">
            {%- render 'price', product: product, use_variant: true, show_badges: true, price_class: 'price--large' -%}
          </div>

          {%- comment -%} Product Form {%- endcomment -%}
          {%- assign product_form_id = 'product-form-' | append: section.id -%}
<product-form>
            {%- form 'product', product, id: product_form_id, class: 'tz-product-form' -%}
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">

            {%- comment -%} Variant Picker {%- endcomment -%}
            {%- unless product.has_only_default_variant -%}
              {%- for option in product.options_with_values -%}
                <div class="tz-variant-option">
                  <div class="tz-variant-label">
                    <span>
                      {{- option.name }}: <span class="tz-variant-selected">{{ option.selected_value }}</span></span
                    >
                  </div>

                  {%- liquid
                    assign swatch_count = option.values | map: 'swatch' | compact | size
                    assign picker_type = 'button'
                    if swatch_count > 0 and option.name == 'Color' or option.name == 'צבע'
                      assign picker_type = 'color-button'
                    endif
                  -%}

                  {%- if picker_type == 'color-button' -%}
                    <div class="tz-color-buttons">
                      {%- for value in option.values -%}
                        <button
                          type="button"
                          class="tz-color-button{% if value == option.selected_value %} is-active{% endif %}"
                          data-value="{{ value | escape }}"
                          data-option-index="{{ forloop.index0 }}"
                          aria-label="{{ value | escape }}"
                        >
                          {{ value }}
                        </button>
                      {%- endfor -%}
                    </div>
                  {%- else -%}
                    {%- if option.name == 'Size' or option.name == 'מידה' -%}
                      <div class="tz-size-grid">
                        {%- for value in option.values -%}
                          {%- assign variant_available = false -%}
                          {%- for variant in product.variants -%}
                            {%- if variant.options[forloop.parentloop.index0] == value and variant.available -%}
                              {%- assign variant_available = true -%}
                              {%- break -%}
                            {%- endif -%}
                          {%- endfor -%}
                          <button
                            type="button"
                            class="tz-size-button{% if value == option.selected_value %} is-active{% endif %}{% unless variant_available %} is-disabled{% endunless %}"
                            data-value="{{ value | escape }}"
                            data-option-index="{{ forloop.index0 }}"
                            {% unless variant_available %}
                              disabled
                            {% endunless %}
                          >
                            {{ value }}
                          </button>
                        {%- endfor -%}
                      </div>
                      {%- if section.settings.show_size_guide -%}
                        <button type="button" class="tz-size-guide-link">
                          <span class="material-icons-outlined">straighten</span>
                          {{ section.settings.size_guide_text | default: 'טבלת מידות' }}
                        </button>
                      {%- endif -%}
                    {%- else -%}
                      <div class="tz-size-grid">
                        {%- for value in option.values -%}
                          <button
                            type="button"
                            class="tz-size-button{% if value == option.selected_value %} is-active{% endif %}"
                            data-value="{{ value | escape }}"
                            data-option-index="{{ forloop.index0 }}"
                          >
                            {{ value }}
                          </button>
                        {%- endfor -%}
                      </div>
                    {%- endif -%}
                  {%- endif -%}
                </div>
              {%- endfor -%}
            {%- endunless -%}

            {%- comment -%} Quantity Selector {%- endcomment -%}
            <div class="tz-product-quantity">
              <label class="tz-quantity-label" for="Quantity-{{ section.id }}">
                {% if is_hebrew %}
                  כמות:
                {% else %}
                  {{ 'products.product.quantity.label' | t | default: 'Quantity' }}:
                {% endif %}
              </label>
              <div class="tz-quantity-input">
                <button
                  type="button"
                  class="tz-quantity-button tz-quantity-plus"
                  aria-label="{{ 'products.product.quantity.increase' | t | default: 'Increase quantity' }}"
                >
                  <span class="material-icons-outlined">add</span>
                </button>
                <input
                  type="number"
                  id="Quantity-{{ section.id }}"
                  name="quantity"
                  class="tz-quantity-field"
                  value="1"
                  min="1"
                  aria-label="{{ 'products.product.quantity.input_label' | t | default: 'Quantity' }}"
                >
                <button
                  type="button"
                  class="tz-quantity-button tz-quantity-minus"
                  aria-label="{{ 'products.product.quantity.decrease' | t | default: 'Decrease quantity' }}"
                >
                  <span class="material-icons-outlined">remove</span>
                </button>
              </div>
            </div>

            {%- comment -%} Buy Button {%- endcomment -%}
            <button
              type="submit"
              name="add"
              class="tz-product-buy-button"
              {% unless product.selected_or_first_available_variant.available %}
                disabled
              {% endunless %}
              data-add-to-cart-text="{% if is_hebrew %}הוספה לסל{% else %}{{ 'products.product.add_to_cart' | t | default: 'Add to cart' }}{% endif %}"
              data-sold-out-text="{% if is_hebrew %}אזל מהמלאי{% else %}{{ 'products.product.sold_out' | t | default: 'Sold out' }}{% endif %}"
            >
              {%- if product.selected_or_first_available_variant.available -%}
                {% if is_hebrew %}
                  הוספה לסל
                {% else %}
                  {{ 'products.product.add_to_cart' | t | default: 'Add to cart' }}
                {% endif %}
              {%- else -%}
                {% if is_hebrew %}
                  אזל מהמלאי
                {% else %}
                  {{ 'products.product.sold_out' | t | default: 'Sold out' }}
                {% endif %}
              {%- endif -%}
            </button>
          {%- endform -%}
          </product-form>

          {%- comment -%} DREAM CARD Block {%- endcomment -%}
          {% if section.settings.show_dream_card %}
            <div class="tz-product-dream-card">
              <p>{{ section.settings.dream_card_text | default: 'חברי מועדון DREAM CARD?' }}</p>
              <p>{{ section.settings.dream_card_points | default: 'בקנייה זו ניתן לצבור כ-100 נקודות' }}</p>
              <div class="tz-product-dream-card-links">
                <a href="{{ section.settings.dream_card_join_url | default: '#' }}">
                  {{- section.settings.dream_card_join_text | default: 'הצטרפות לדרים קארד' -}}
                </a>
                <span>|</span>
                <a href="{{ section.settings.dream_card_login_url | default: '#' }}">
                  {{- section.settings.dream_card_login_text | default: 'התחברות לדרים קארד' -}}
                </a>
              </div>
            </div>
          {% endif %}

          {%- comment -%} Wishlist Button {%- endcomment -%}
          {% if section.settings.show_wishlist %}
            <button type="button" class="tz-product-wishlist" data-product-id="{{ product.id }}">
              <span class="material-icons-outlined">favorite_border</span>
              {{ 'products.product.wishlist.button' | t | default: 'My list' }}
            </button>
          {% endif %}

          {%- comment -%} Service Icons (Order: gift, return, exchange, supply) {%- endcomment -%}
          {% if section.settings.show_service_icons %}
            <div class="tz-product-service-icons">
              <div class="tz-product-service-icon">
                <div class="tz-product-service-icon-wrapper">
                  <span class="material-icons-outlined">card_giftcard</span>
                </div>
                <span class="tz-product-service-icon-text">{{ section.settings.service_gift_text | default: 'מתנה' }}</span>
              </div>
              <div class="tz-product-service-icon">
                <div class="tz-product-service-icon-wrapper">
                  <span class="material-icons-outlined">keyboard_return</span>
                </div>
                <span class="tz-product-service-icon-text">{{ section.settings.service_return_text | default: 'החזרה' }}</span>
              </div>
              <div class="tz-product-service-icon">
                <div class="tz-product-service-icon-wrapper">
                  <span class="material-icons-outlined">sync_alt</span>
                </div>
                <span class="tz-product-service-icon-text">{{ section.settings.service_exchange_text | default: 'החלפה' }}</span>
              </div>
              <div class="tz-product-service-icon">
                <div class="tz-product-service-icon-wrapper">
                  <span class="material-icons-outlined">local_shipping</span>
                </div>
                <span class="tz-product-service-icon-text">{{ section.settings.service_shipping_text | default: 'אספקה' }}</span>
              </div>
            </div>
          {% endif %}

          {%- comment -%} Accordion Sections {%- endcomment -%}
          <div class="tz-product-accordion">
            {%- for block in section.blocks -%}
              {%- if block.type == 'collapsible_tab' -%}
                <details class="tz-accordion-item" {{ block.shopify_attributes }}>
                  <summary class="tz-accordion-summary">
                    <span class="material-icons-outlined tz-accordion-icon">add</span>
                    <span class="tz-accordion-title">
                      {{- block.settings.heading | default: block.settings.page.title | escape -}}
                    </span>
                  </summary>
                  <div class="tz-accordion-content">
                    {{ block.settings.content }}
                    {{ block.settings.page.content }}
                  </div>
                </details>
              {%- endif -%}
            {%- endfor -%}
          </div>

          {%- comment -%} Product Description {%- endcomment -%}
          {%- if section.settings.show_product_description and product.description != blank -%}
            <div class="tz-product-description">
              <div class="tz-product-description__content">
                {{ product.description }}
              </div>
            </div>
          {%- endif -%}
        </div>
      </div>

      {%- comment -%} Product Media Gallery (Left Side - RTL) {%- endcomment -%}
      {%- if product.media.size > 0 -%}
        <div class="tz-product-gallery">
          {%- comment -%} Main Image Container (Left side) {%- endcomment -%}
          <div class="tz-product-main-image">
            {%- assign featured_media = product.selected_or_first_available_variant.featured_media
              | default: product.featured_media
            -%}
            {%- if featured_media -%}
              <img
                id="tz-product-main-img"
                src="{{ featured_media | image_url: width: 1200 }}"
                alt="{{ featured_media.alt | escape | default: product.title | escape }}"
                width="{{ featured_media.width }}"
                height="{{ featured_media.height }}"
                loading="eager"
              >
            {%- else -%}
              <img
                id="tz-product-main-img"
                src="{{ product.featured_image | image_url: width: 1200 }}"
                alt="{{ product.featured_image.alt | escape | default: product.title | escape }}"
                width="{{ product.featured_image.width }}"
                height="{{ product.featured_image.height }}"
                loading="eager"
              >
            {%- endif -%}

            {%- comment -%} Gallery Action Buttons {%- endcomment -%}
            <button type="button" class="tz-product-zoom-button" aria-label="Zoom">
              <span class="material-icons-outlined">zoom_in</span>
            </button>
            <button type="button" class="tz-product-share-button" aria-label="Share">
              <span class="material-icons-outlined">share</span>
            </button>
          </div>

          {%- comment -%} Thumbnail Strip (Right side of main image) {%- endcomment -%}
          <div class="tz-product-thumbnails">
            {%- for media in product.media limit: 10 -%}
              <button
                type="button"
                class="tz-product-thumbnail{% if forloop.first %} is-active{% endif %}"
                data-media-id="{{ media.id }}"
                data-media-index="{{ forloop.index0 }}"
                aria-label="{{ 'products.product.media.load_image' | t: index: forloop.index }}"
              >
                {%- if media.media_type == 'image' -%}
                  <img
                    src="{{ media.preview_image | image_url: width: 80 }}"
                    alt="{{ media.alt | escape }}"
                    width="80"
                    height="80"
                    loading="lazy"
                  >
                {%- else -%}
                  <div class="tz-product-thumbnail-placeholder">
                    <span class="material-icons-outlined">play_circle</span>
                  </div>
                {%- endif -%}
              </button>
            {%- endfor -%}
          </div>
        </div>
      {%- endif -%}
    </div>
  </div>
</product-info>

<script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "Product Page",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "show_breadcrumb",
      "default": true,
      "label": "Show Breadcrumb Navigation"
    },
    {
      "type": "header",
      "content": "Product Information"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": true,
      "label": "Show Vendor/Brand"
    },
    {
      "type": "checkbox",
      "id": "show_last_call_badge",
      "default": false,
      "label": "Show Last Call Badge",
      "info": "Or use product metafield: custom.last_call"
    },
    {
      "type": "header",
      "content": "DREAM CARD"
    },
    {
      "type": "checkbox",
      "id": "show_dream_card",
      "default": true,
      "label": "Show DREAM CARD Block"
    },
    {
      "type": "text",
      "id": "dream_card_text",
      "default": "חברי מועדון DREAM CARD?",
      "label": "DREAM CARD Question Text"
    },
    {
      "type": "text",
      "id": "dream_card_points",
      "default": "בקנייה זו ניתן לצבור כ-100 נקודות",
      "label": "DREAM CARD Points Text"
    },
    {
      "type": "url",
      "id": "dream_card_join_url",
      "label": "Join DREAM CARD Link"
    },
    {
      "type": "text",
      "id": "dream_card_join_text",
      "default": "הצטרפות לדרים קארד",
      "label": "Join Link Text"
    },
    {
      "type": "url",
      "id": "dream_card_login_url",
      "label": "Login DREAM CARD Link"
    },
    {
      "type": "text",
      "id": "dream_card_login_text",
      "default": "התחברות לדרים קארד",
      "label": "Login Link Text"
    },
    {
      "type": "header",
      "content": "Wishlist"
    },
    {
      "type": "checkbox",
      "id": "show_wishlist",
      "default": true,
      "label": "Show Wishlist Button"
    },
    {
      "type": "header",
      "content": "Service Icons"
    },
    {
      "type": "checkbox",
      "id": "show_service_icons",
      "default": true,
      "label": "Show Service Icons"
    },
    {
      "type": "text",
      "id": "service_shipping_text",
      "default": "אספקה",
      "label": "Shipping Text"
    },
    {
      "type": "text",
      "id": "service_exchange_text",
      "default": "החלפה",
      "label": "Exchange Text"
    },
    {
      "type": "text",
      "id": "service_return_text",
      "default": "החזרה",
      "label": "Return Text"
    },
    {
      "type": "text",
      "id": "service_gift_text",
      "default": "מתנה",
      "label": "Gift Text"
    },
    {
      "type": "header",
      "content": "Product Description"
    },
    {
      "type": "checkbox",
      "id": "show_product_description",
      "default": true,
      "label": "Show Product Description"
    },
    {
      "type": "header",
      "content": "Size Guide"
    },
    {
      "type": "checkbox",
      "id": "show_size_guide",
      "default": true,
      "label": "Show Size Guide Link"
    },
    {
      "type": "text",
      "id": "size_guide_text",
      "default": "טבלת מידות",
      "label": "Size Guide Text"
    }
  ],
  "blocks": [
    {
      "type": "collapsible_tab",
      "name": "Accordion Tab",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "default": "Product Details",
          "label": "Heading"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content"
        },
        {
          "type": "page",
          "id": "page",
          "label": "Or select a page"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Page",
      "blocks": [
        {
          "type": "collapsible_tab",
          "settings": {
            "heading": "פרטים"
          }
        },
        {
          "type": "collapsible_tab",
          "settings": {
            "heading": "על המותג"
          }
        },
        {
          "type": "collapsible_tab",
          "settings": {
            "heading": "משלוחים והחזרות"
          }
        }
      ]
    }
  ]
}
{% endschema %}
